<p class="breadcrumb">
  <a routerLink="/courses">‚Üê Retour aux cours</a>
</p>

<section class="page" *ngIf="course as c">
  <header class="page-head">
    <div class="title">
      <h2>{{ c.title }}</h2>
      <p class="subtitle">#{{ c.id }} ‚Äî {{ c.description }}</p>
    </div>

    <div class="actions">
      <div class="search">
        <input type="search"
               placeholder="Rechercher une le√ßon‚Ä¶"
               [value]="search"
               (input)="onSearch($event)">
        <span class="icon">üîé</span>
      </div>
      <button class="btn primary dark" (click)="openCreate()">
        <span class="icon">Ôºã</span> Ajouter une le√ßon
      </button>
    </div>
  </header>

  <!-- TABLE -->
  <div *ngIf="!loading && filtered().length" class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th style="width:80px">ID</th>
          <th>Titre</th>
          <th>Contenu</th>
          <th style="width:200px">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let l of filtered(); trackBy: trackById">
          <td class="muted">#{{ l.id }}</td>

          <td>
            <div class="cell-title" [title]="l.title">{{ l.title }}</div>
          </td>

          <td>
            <!-- Contenu long avec Lire plus / Lire moins -->
            <div class="cell-desc" [class.expanded]="expanded[l.id!]">
              {{ l.content }}
            </div>
            <button class="btn link"
                    *ngIf="(l.content?.length || 0) > 260"
                    (click)="toggleExpand(l)">
              {{ expanded[l.id!] ? 'Lire moins' : 'Lire plus' }}
            </button>
          </td>

          <td class="row-actions">
            <button class="btn ghost" (click)="openEdit(l)" title="Modifier">‚úèÔ∏è</button>
            <button class="btn danger ghost" (click)="askDelete(l)" title="Supprimer">üóëÔ∏è</button>
            <button class="btn ai-tool" (click)="generateSummary(l.id!)" title="G√©n√©rer r√©sum√© IA">
              ü§ñ R√©sum√© IA
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Aucun r√©sultat -->
  <div *ngIf="!loading && filtered().length === 0" class="empty">
    <h3>Aucune le√ßon</h3>
    <p>Ajoute la premi√®re le√ßon de ce cours.</p>
    <button class="btn primary dark" (click)="openCreate()">Cr√©er une le√ßon</button>
  </div>

  <!-- R√©sum√© IA (affichage temporaire) -->
  <div *ngIf="summaryVisible">
    <div *ngIf="loadingSummary" class="ai-box">
      <div class="spinner"></div>
      <p>Analyse IA en cours...</p>
    </div>

    <div *ngIf="aiSummary && !loadingSummary" class="ai-summary-card">
      <h3>üß† R√©sum√© g√©n√©r√© par l‚ÄôIA :</h3>
      <p>{{ aiSummary }}</p>
      <small class="hint">*Ce r√©sum√© s‚Äôeffacera automatiquement apr√®s quelques secondes*</small>
    </div>
  </div>

  <!-- ========= MODAL CR√âER / MODIFIER ========= -->
  <div class="backdrop" *ngIf="modalOpen" (click)="closeModal()"></div>
  <div class="modal centered" *ngIf="modalOpen" (click)="$event.stopPropagation()">
    <div class="modal-head">
      <h3>{{ form.value.id ? 'Modifier la le√ßon' : 'Nouvelle le√ßon' }}</h3>
      <button class="icon-btn" (click)="closeModal()">‚úñ</button>
    </div>

    <form [formGroup]="form" (ngSubmit)="submit()" class="modal-body">
      <label class="field">
        <input formControlName="title" placeholder=" " autocomplete="off">
        <span>Titre</span>
        <small class="error" *ngIf="form.get('title')?.invalid && form.get('title')?.touched">
          Le titre est requis.
        </small>
      </label>

      <label class="field">
        <textarea rows="8" formControlName="content" placeholder=" "></textarea>
        <span>Contenu (long accept√©)</span>
        <small class="error" *ngIf="form.get('content')?.invalid && form.get('content')?.touched">
          Le contenu est requis.
        </small>
      </label>

      <div class="modal-actions">
        <button type="button" class="btn ghost" (click)="closeModal()">Annuler</button>
        <button type="submit" class="btn primary dark" [disabled]="form.invalid">
          {{ form.value.id ? 'Enregistrer' : 'Cr√©er' }}
        </button>
      </div>
    </form>
  </div>

  <!-- ========= CONFIRM SUPPRESSION ========= -->
  <div class="backdrop" *ngIf="confirmOpen" (click)="cancelDelete()"></div>
  <div class="modal small centered" *ngIf="confirmOpen" (click)="$event.stopPropagation()">
    <div class="modal-head">
      <h3>Supprimer cette le√ßon ?</h3>
      <button class="icon-btn" (click)="cancelDelete()">‚úñ</button>
    </div>
    <div class="modal-body">
      <p>Cette action est d√©finitive.</p>
      <div class="modal-actions">
        <button class="btn ghost" (click)="cancelDelete()">Annuler</button>
        <button class="btn danger" (click)="confirmDelete()">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" *ngIf="toast" [class.error]="toast?.type === 'error'">
    {{ toast?.text }}
  </div>
</section>
